# 라이믹스 게시물 웹훅 발송 애드온 v0.5.5

이 애드온은 라이믹스(XE/Rhymix)에서 게시물이 작성되거나 수정될 때 웹훅을 통해 외부 서비스로 알림을 보내는 기능을 제공합니다.
라이믹스 코어 표준 기능을 활용하도록 이전버전에서 개선되었습니다. 

## 주요 기능

- 게시물 작성 및 수정 시 웹훅 발송
- 관리자 페이지에서 웹훅 URL 설정
- 웹훅 트리거 옵션 설정 (새 게시물 작성 시, 게시물 수정 시)
- 정확한 새 글/수정 글 판별 로직 적용
- 임시 저장 후 발행되는 게시물도 새 글로 정확히 인식

## 설치 방법

1. 이 저장소를 다운로드하거나 클론합니다.
2. 다운로드한 파일을 라이믹스의 `addons` 디렉토리 아래에 `webhook_sender` 폴더를 생성하여 복사합니다.
   - 설치 경로: `/path/to/rhymix/addons/webhook_sender/`
3. 라이믹스 관리자 페이지에서 애드온 관리로 이동합니다.
4. 목록에서 "라이믹스 게시물 웹훅 발송 애드온"을 찾아 활성화합니다.
5. 애드온 설정에서 웹훅 URL을 설정합니다.
6. 웹훅을 사용할 게시판 모듈에서 애드온을 활성화합니다.

## 설정 방법

1. 라이믹스 관리자 페이지에서 애드온 관리로 이동합니다.
2. "라이믹스 게시물 웹훅 발송 애드온"의 설정 버튼을 클릭합니다.
3. 다음 설정을 입력합니다:
   - **웹훅 URL**: 알림을 보낼 웹훅 URL을 입력합니다. (예: https://n8n.example.com/webhook/...)
   - **새 게시물 작성 시 웹훅 발송**: 새 게시물이 작성될 때 웹훅을 발송할지 여부를 선택합니다.
   - **게시물 수정 시 웹훅 발송**: 게시물이 수정될 때 웹훅을 발송할지 여부를 선택합니다.
   - **웹훅 콘텐츠 길이 제한**: 웹훅으로 전송되는 게시글 내용의 최대 길이를 지정합니다. 비워두거나 0을 입력하면 길이 제한 없이 전체 내용을 전송합니다. (기본값: 글자수 제한없음)
4. 설정을 저장합니다.
5. 애드온 관리 페이지에서 웹훅을 발송할 모듈에 대해 애드온을 활성화합니다.

## 트리거 옵션 설명

- **새 게시물 작성 시 웹훅 발송**: '예'로 설정하면 새 게시물이 작성될 때 웹훅이 발송됩니다.
- **게시물 수정 시 웹훅 발송**: '예'로 설정하면 게시물이 수정될 때 웹훅이 발송됩니다.
- 두 옵션 모두 '예'로 설정하면 새 게시물 작성과 게시물 수정 시 모두 웹훅이 발송됩니다.
- 두 옵션 모두 '아니오'로 설정하면 웹훅이 발송되지 않습니다.

## 새 글/수정 글 판별 로직

이 애드온은 다음과 같은 정교한 방식으로 새 글과 수정 글을 판별합니다:

1. **update_order 값 확인**: 게시글의 update_order 값이 0보다 크면 확실한 수정으로 판단합니다.
2. **문서 상태 확인**: 이미 발행된 문서가 있고 임시저장 상태가 아니면 수정으로 판단합니다.
3. **시간 차이 분석**: 등록일과 최종 수정일의 시간 차이가 1분 이내면 새 글로 간주합니다.
4. **임시 저장 처리**: 임시 저장 후 발행되는 경우에도 새 글로 정확히 인식합니다.

이러한 개선된 판별 로직을 통해 글 작성에 시간이 오래 걸리는 경우나 임시 저장 후 발행하는 경우에도 정확하게 웹훅이 발송됩니다.

## 웹훅 데이터 형식

웹훅으로 전송되는 데이터는 다음과 같은 JSON 형식입니다:

```json
{
  "title": "게시글 제목",
  "content": "게시글 내용 (HTML 태그가 정리된 텍스트)",
  "module_srl": "게시판 모듈 SRL",
  "board_name": "게시판 이름",
  "url": "게시글 URL",
  "message": "알림 메시지",
  "author": "작성자 닉네임",
  "member_srl": "작성자 회원 SRL",
  "regdate": "등록일시 (Y-m-d H:i:s)",
  "last_update": "수정일시 (Y-m-d H:i:s)",
  "is_new": true/false,
  "is_update": true/false
}
```

## 주요 변경 사항 (v0.5.5)

- 새 글/수정 글 판별 로직 개선: 임시 저장 후 발행되는 게시물을 정확히 새 글로 인식
- 글 작성에 시간이 오래 걸리는 경우에도 웹훅 발송 안정성 향상
- 다중 지표(update_order, 문서 상태, 시간 차이)를 활용한, 더 정확한 판별 알고리즘 적용

## 주요 변경 사항 (이전 버전)

- 모듈별 활성화 방식 도입: 특정 게시판에만 웹훅 발송 기능은 라이믹스 기본 애드온 활성화 방식으로 변경
- 타임스탬프 형식 통일: 모든 타임스탬프는 라이믹스 표준 형식(Y-m-d H:i:s)으로 통일
- 라이믹스 HTTP 라이브러리 사용: curl 직접 사용 대신 Rhymix\Framework\HTTP 또는 FileHandler 클래스 활용
- SSL 인증서 검증 활성화: 보안 강화를 위해 기본적으로 SSL 인증서 검증 활성화
- 비동기 처리 개선: 라이믹스 Queue 시스템을 활용한 안정적인 비동기 처리 구현
- 코드 구조 개선: 역할별로 함수 분리 및 중복 코드 제거
- 로그 기능 추가: 웹훅 발송 과정의 로그를 파일에 기록하는 기능 추가
- 본문 처리 개선: strip_tags() 대신 라이믹스의 getSummary() 메서드를 사용하여 HTML 태그를 더 효과적으로 제거

## 주의사항

- 웹훅 URL은 반드시 https:// 또는 http://로 시작해야 합니다.
- 웹훅 발송 시 네트워크 문제로 지연이 발생할 수 있습니다.
- 웹훅 수신 서버가 응답하지 않을 경우 게시물 등록에는 영향을 주지 않습니다.
- SSL 인증서 검증이 활성화되어 있으므로, 유효한 인증서를 사용하는 웹훅 URL을 사용해야 합니다.

## 라이선스

이 애드온은 MIT 라이선스 하에 배포됩니다.

## 문의 및 버그 리포트

문제가 발생하거나 기능 개선 요청이 있으시면 GitHub 이슈를 통해 알려주세요. 

## 제작자  

라이프오브파이 (indend007@gmail.com)